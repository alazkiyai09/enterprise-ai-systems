# ============================================================
# Enterprise-RAG: Simple Docker Compose (ChromaDB - No Qdrant)
# ============================================================
# Simplified deployment using ChromaDB (embedded, no external service needed)

version: '3.8'

services:
  # ============================================================
  # RAG API Service
  # ============================================================
  rag-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: enterprise-rag-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # API Configuration
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - CORS_ORIGINS=http://localhost:8501,http://localhost:3000

      # Security Configuration
      - API_KEYS=${API_KEYS:-}
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}
      - ENVIRONMENT=${ENVIRONMENT:-development}

      # LLM Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - LLM_MODEL=${LLM_MODEL:-gpt-4o-mini}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.1}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS:-1024}

      # Embedding Configuration
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-sentence-transformers/all-MiniLM-L6-v2}
      - RERANKER_MODEL=${RERANKER_MODEL:-cross-encoder/ms-marco-MiniLM-L-6-v2}

      # Retrieval Configuration
      - CHUNK_SIZE=${CHUNK_SIZE:-512}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-50}
      - TOP_K_RETRIEVAL=${TOP_K_RETRIEVAL:-20}
      - TOP_K_RERANK=${TOP_K_RERANK:-5}
      - ENABLE_BM25=${ENABLE_BM25:-true}
      - ENABLE_HYBRID_SEARCH=${ENABLE_HYBRID_SEARCH:-true}

      # Vector Database Configuration - Using ChromaDB (embedded)
      - VECTOR_STORE_TYPE=chroma
      - CHROMA_PATH=./data/chroma

      # Logging Configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-text}

      # Evaluation
      - ENABLE_EVALUATION=${ENABLE_EVALUATION:-true}

    volumes:
      # Mount data directories for persistence
      - ./data/documents:/app/data/documents
      - ./data/chroma:/app/data/chroma
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - rag-network
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

  # ============================================================
  # Streamlit UI Service (Optional)
  # ============================================================
  rag-ui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: enterprise-rag-ui
    restart: unless-stopped
    ports:
      - "8501:8501"
    environment:
      - API_URL=http://rag-api:8000
    command: >
      streamlit run src/ui/app.py
      --server.port=8501
      --server.address=0.0.0.0
      --server.headless=true
    volumes:
      - ./data/documents:/app/data/documents
    depends_on:
      rag-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - rag-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 512M
    profiles:
      - ui

networks:
  rag-network:
    driver: bridge
    name: enterprise-rag-network
